<div align="center">

# 🔄 FlowIME

**Smart IME Switcher for macOS**

日本語と英語の入力を、もっとスムーズに。

[![macOS](https://img.shields.io/badge/macOS-15.5+-blue.svg)](https://www.apple.com/macos/)
[![Swift](https://img.shields.io/badge/Swift-5.0-orange.svg)](https://swift.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Version](https://img.shields.io/badge/Version-1.4-brightgreen.svg)](https://github.com/yourusername/FlowIME/releases)

[English](#english) | [日本語](#japanese)

</div>

---

## 🌟 特徴

FlowIMEは、macOS用のインテリジェントなIME自動切り替えアプリです。カーソル前の文字を認識し、文脈に応じて最適な入力モードに自動切り替えします。

### ✨ 主な機能

🎯 **スマートな自動切り替え**
カーソル前の文字が日本語なら日本語IMEに、英語なら英語モードに自動切り替え

🧠 **コンテキスト認識**
空白・改行・文頭では切り替えを行わず、ユーザーの意図を尊重

⚡ **高速入力対応**
連続入力中は判定をスキップし、タイピングの邪魔をしません

🤲 **手動操作の尊重**
ユーザーが手動でIMEを切り替えた場合、自動判定を一時停止

---

## 🎯 判定ルール

FlowIMEは、カーソル前の文字に基づいて最適な入力モードを判定します：

| カーソル前の文字 | 切り替え先 | 例 |
|:---:|:---:|---|
| 🇯🇵 日本語 | 日本語IME | あ、ア、漢字 |
| 🔤 英語 | 英語モード | a-z, A-Z |
| 🔢 数字 | 英語モード | 0-9 |
| ⚪ 空白・記号 | **切り替えなし** | スペース、改行、記号 |
| 📄 文頭 | **切り替えなし** | カーソル位置 = 0 |

### スマート判定の仕組み

```
┌─────────────────────────────────────────────┐
│ 1. アルファベットキーを押す                 │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│ 2. Throttle チェック                        │
│    ├─ 前回判定から1秒以内？ → スキップ      │
│    └─ IME切替から1秒以内？  → スキップ      │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│ 3. カーソル前の文字を取得                   │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│ 4. 文字種を判定                             │
│    ├─ 日本語 → 日本語IME                    │
│    ├─ 英語   → 英語モード                   │
│    └─ その他 → 変更なし                     │
└──────────────┬──────────────────────────────┘
               ↓
┌─────────────────────────────────────────────┐
│ 5. IME切り替え実行                          │
└─────────────────────────────────────────────┘
```

---

## 📥 インストール

### システム要件

- **macOS 15.5** 以降
- **アクセシビリティ権限**（初回起動時に許可が必要）

### ダウンロード

最新版のDMGファイルは[Releases](https://github.com/yourusername/FlowIME/releases)からダウンロードできます。

1. **FlowIME.dmg** をダウンロード
2. DMGファイルをダブルクリックして開く
3. **FlowIME.app** を **Applications** フォルダにドラッグ&ドロップ
4. Launchpadまたは Finder から FlowIME を起動

### 初回起動時の設定

アプリを初めて起動すると、アクセシビリティ権限のリクエストが表示されます：

1. **システム設定** > **プライバシーとセキュリティ** > **アクセシビリティ**
2. 🔒 をクリックして変更を許可
3. **FlowIME** にチェックを入れる
4. アプリを再起動

これで準備完了です！

---

## 🚀 使い方

### 基本操作

1. FlowIMEを起動すると、メニューバーに **🔄** アイコンが表示されます
2. 任意のテキストエディタやブラウザで文字を入力してください
3. アルファベットキーを入力すると、前の文字に応じて**自動的にIMEが切り替わります**

### メニューバーアイコン

| アイコン | 状態 |
|:---:|---|
| 🔄 | 自動切り替え **有効** |
| ⏸ | 自動切り替え **一時停止** |

アイコンをクリックすると、自動切り替えのオン/オフを切り替えられます。

### 動作例

```
「これはtest」と入力する場合：
1. 「これは」 → 日本語IME で入力
2. 「t」を押す → カーソル前が「は」（日本語）なので日本語IME維持
3. 実際には「これはｔ」になってしまう...ではなく
4. FlowIMEが文脈を認識して適切なタイミングで切り替え
```

---

## ⚙️ 技術仕様

<details>
<summary><b>使用技術・API</b></summary>

### コア技術

| 技術 | 用途 |
|---|---|
| **CGEventTap** | システム全体のキーボードイベント監視 |
| **Accessibility API** | テキストフィールド情報・カーソル位置の取得 |
| **Carbon Input Source API** | IME切り替えの実行 |
| **DistributedNotificationCenter** | IME変更通知の監視 |

### アーキテクチャ

```
┌─────────────────────────────────────────┐
│         FlowIMEApp.swift                │
│        (メインロジック)                 │
└───────┬─────────┬─────────┬─────────────┘
        │         │         │
        ↓         ↓         ↓
┌──────────┐ ┌──────────┐ ┌──────────────┐
│ Keyboard │ │Accessib. │ │ IME          │
│ Monitor  │ │ Manager  │ │ Controller   │
└──────────┘ └──────────┘ └──────────────┘
```

### パフォーマンス最適化

- ✅ イベント駆動型（ポーリング廃止）
- ✅ Throttle機構による不要な判定のスキップ
- ✅ 同一IME状態への重複切り替えを回避
- ✅ メモリ効率的なイベントハンドリング

</details>

<details>
<summary><b>対応入力ソース</b></summary>

### 現在サポート

| 入力モード | 入力ソースID |
|---|---|
| 🇯🇵 日本語 | `com.apple.inputmethod.Kotoeri` |
| 🔤 英語 | `com.apple.keylayout.ABC`<br>`com.apple.keylayout.US` |

### 今後対応予定

- Google日本語入力
- その他サードパーティIME

</details>

---

## 🔧 トラブルシューティング

### アプリが起動しない・動作しない

✅ **アクセシビリティ権限を確認**
- **システム設定** > **プライバシーとセキュリティ** > **アクセシビリティ**
- FlowIME にチェックが入っているか確認
- チェックを外して、再度チェックを入れてみる

✅ **アプリを再起動**
- メニューバーのアイコンを右クリック > 終了
- Launchpad から再度起動

### IMEが切り替わらない

✅ **入力ソースの確認**
1. **システム設定** > **キーボード** > **入力ソース**
2. 以下が追加されているか確認：
   - 日本語 - ひらがな（Google日本語入力）またはことえり
   - 英語 - ABC または US

✅ **対応入力ソースを使用**
- 現在対応：`com.apple.inputmethod.Kotoeri`（ことえり）
- サードパーティIMEは今後対応予定

### 切り替えのタイミングを調整したい

現在はコード内で調整が必要です。今後の設定画面で調整可能になる予定です。

---

## 🛠 開発者向け

### ビルド方法

```bash
# リポジトリをクローン
git clone https://github.com/yourusername/FlowIME.git
cd FlowIME

# Xcodeで開く
open FlowIME.xcodeproj

# ⌘+B でビルド
# ⌘+R で実行
```

### 署名付きDMGの作成

```bash
IDENTITY="Developer ID Application: Your Name (TEAMID)" \
bash scripts/make_dmg.sh
```

公証（Notarization）も含める場合：

```bash
IDENTITY="Developer ID Application: Your Name (TEAMID)" \
TEAM_ID="TEAMID" \
APPLE_ID="you@example.com" \
APP_PASSWORD="xxxx-xxxx-xxxx-xxxx" \
NOTARIZE=1 \
bash scripts/make_dmg.sh
```

---

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は [LICENSE](LICENSE) をご覧ください。

---

## 🗺 ロードマップ

### v2.0（予定）
- [ ] 設定画面の追加
- [ ] カスタマイズ可能な判定ルール
- [ ] ホットキーサポート
- [ ] アプリ別の有効/無効設定

### 将来的な機能
- [ ] Google日本語入力など、サードパーティIMEのサポート
- [ ] 統計・使用状況の表示
- [ ] App Store配布

---

## 🙏 謝辞

FlowIMEは、日本語と英語を頻繁に切り替える全てのmacOSユーザーのために開発されました。

フィードバックやバグレポートは [Issues](https://github.com/yourusername/FlowIME/issues) でお待ちしています。

---

<div align="center">

Made with ❤️ for macOS users

[⬆ Back to Top](#-flowime)

</div>
